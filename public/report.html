<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û—Ç—á—ë—Ç—ã ‚Äî –†–µ—Å—Ç–æ—Ä–∞–Ω</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>–û—Ç—á—ë—Ç—ã</h1>
  <a href="index.html">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</a>

  <section>
    <h2>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</h2>
    <div id="revenue"></div>
    <h3>–ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü</h3>
    <input id="planInput" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–ª–∞–Ω ‚ÇΩ">
    <button id="savePlan">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω</button>
  </section>

  <section>
    <h2>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º</h2>
    <button id="loadWeeklyPlan">–ü–æ–∫–∞–∑–∞—Ç—å</button>
    <div id="weeklyPlan"></div>
  </section>

  <section>
    <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ 2025 ‚Üî 2024 –ø–æ –Ω–µ–¥–µ–ª—è–º</h2>
    <button id="loadWeeklyCompare">–ü–æ–∫–∞–∑–∞—Ç—å</button>
    <div id="weeklyCompare"></div>
  </section>

  <script>
  document.addEventListener("DOMContentLoaded", () => {

    async function loadRevenue() {
      const res = await fetch("/report/revenue");
      const d = await res.json();
      document.getElementById("revenue").innerHTML = `
        <table>
          <tr><th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
          <tr><td>–í—ã—Ä—É—á–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞</td><td>${d.curSum.toFixed(0)} ‚ÇΩ</td></tr>
          <tr><td>–ü—Ä–æ—à–ª—ã–π –≥–æ–¥ (—Ç–æ—Ç –∂–µ –º–µ—Å—è—Ü)</td><td>${d.lastSum.toFixed(0)} ‚ÇΩ</td></tr>
          <tr><td>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</td><td>${d.diff.toFixed(0)} ‚ÇΩ (${d.percent.toFixed(1)}%)</td></tr>
          <tr><td>–ü—Ä–æ–≥–Ω–æ–∑</td><td>${d.forecast.toFixed(0)} ‚ÇΩ</td></tr>
          <tr><td>–ü–ª–∞–Ω</td><td>${d.plan.toFixed(0)} ‚ÇΩ</td></tr>
          <tr><td>–û—Å—Ç–∞–ª–æ—Å—å –¥–æ –ø–ª–∞–Ω–∞</td><td>${d.remain.toFixed(0)} ‚ÇΩ</td></tr>
          <tr><td>–ù—É–∂–Ω–æ –≤ –¥–µ–Ω—å</td><td>${d.needPerDay.toFixed(0)} ‚ÇΩ</td></tr>
        </table>`;
      document.getElementById("planInput").value = d.plan.toFixed(0);
    }

    async function loadWeeklyPlan() {
      const res = await fetch("/report/weekly-plan");
      const d = await res.json();
      document.getElementById("weeklyPlan").innerHTML = `
        <table>
          <tr><th>–ù–µ–¥–µ–ª—è</th><th>–í—ã—Ä—É—á–∫–∞</th><th>% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th></tr>
          ${d.result.map(r => `
            <tr>
              <td>${r.week}</td>
              <td>${r.revenue.toFixed(0)} ‚ÇΩ</td>
              <td>${r.percent.toFixed(1)}%</td>
            </tr>
          `).join("")}
          <tr><th>–ü–ª–∞–Ω –º–µ—Å—è—Ü–∞</th><th>${d.plan.toFixed(0)} ‚ÇΩ</th><th></th></tr>
        </table>`;
    }

    async function loadWeeklyCompare() {
      const res = await fetch("/report/weekly-compare");
      const data = await res.json();
      document.getElementById("weeklyCompare").innerHTML = `
        <table>
          <tr>
            <th>–ù–µ–¥–µ–ª—è</th><th>–í—ã—Ä—É—á–∫–∞ 2024</th><th>–í—ã—Ä—É—á–∫–∞ 2025</th><th>Œî%</th>
            <th>–ì–æ—Å—Ç–∏ 2024</th><th>–ì–æ—Å—Ç–∏ 2025</th><th>Œî%</th>
            <th>–ß–µ–∫–∏ 2024</th><th>–ß–µ–∫–∏ 2025</th><th>Œî%</th>
            <th>–°—Ä.—á–µ–∫ 2024</th><th>–°—Ä.—á–µ–∫ 2025</th><th>Œî%</th>
          </tr>
          ${data.map(r => `
            <tr>
              <td>${r.week}</td>
              <td>${r.rev2024.toFixed(0)}</td>
              <td>${r.rev2025.toFixed(0)}</td>
              <td>${r.pctRev.toFixed(1)}%</td>
              <td>${r.g2024}</td>
              <td>${r.g2025}</td>
              <td>${r.pctGuests.toFixed(1)}%</td>
              <td>${r.c2024}</td>
              <td>${r.c2025}</td>
              <td>${r.pctChecks.toFixed(1)}%</td>
              <td>${r.avg2024.toFixed(0)}</td>
              <td>${r.avg2025.toFixed(0)}</td>
              <td>${r.pctAvg.toFixed(1)}%</td>
            </tr>`).join("")}
        </table>`;
    }

    // === –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ===
    document.getElementById("savePlan").onclick = async () => {
      const now = new Date();
      const plan = parseFloat(document.getElementById("planInput").value);
      await fetch("/plan/set", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({year: now.getFullYear(), month: now.getMonth() + 1, plan})
      });
      await loadRevenue();
      await loadWeeklyPlan();
    };

    document.getElementById("loadWeeklyPlan").onclick = loadWeeklyPlan;
    document.getElementById("loadWeeklyCompare").onclick = loadWeeklyCompare;

    // === –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ ===
    loadRevenue();

  });
  </script>
</body>
</html>
